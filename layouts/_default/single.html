{{ define "title" }}{{ .Title }}{{ end }}

{{ define "css" }}

{{ if site.Params.customSyntaxHighlighting }}
<link rel="stylesheet" data-custom-syntax-highlighting />
<style>
    .chroma {
        padding: 1em;
        background-color: var(--dream-pre-bg, #f5f5f5);
        border-radius: .5em;
        overflow: auto;
    }

    html.dark .chroma {
        background-color: var(--dream-pre-bg-dark, #262626);
    }
</style>
{{ else }}
<style>
    pre {
        padding: 1em;
        overflow: auto;
    }
</style>
{{ end }}

{{ partialCached "commentSystemHeads.html" . }}

{{/* 加密模块CSS */}}
{{ partial "encrypt/assets/css" . }}

{{ end }}

{{ define "main" }}
<div class="lg:grid lg:grid-cols-4 gap-4 mt-4 px-4">

    <div class="lg:col-span-2">
        <article class="mx-auto prose prose-quoteless dark:prose-invert" id="dream-single-post-main" itemscope
            itemtype="http://schema.org/Article">
            {{ template "_internal/schema.html" . }}

            <header>
                <h1 itemprop="headline">{{ .Title }}</h1>
                <p class="text-sm">
                    {{ if site.Params.Experimental.jsDate }}
                    <span data-format="luxon">{{ .Date.Format "2006-01-02T15:04:05Z07:00" }}</span>
                    {{ else }}
                    {{ .Date | time.Format "Monday, Jan 2, 2006" }}
                    {{ end }}

                    | <span>📖 {{ partial "reading-time.html" . }}</span>

                    {{ if ne .Params.nolastmod true }}
                    | <span>{{ T "updatedAt" }}
                        {{ if site.Params.Experimental.jsDate }}
                        <span data-format="luxon">{{ .Lastmod.Format "2006-01-02T15:04:05Z07:00" }}</span>
                        {{ else }}
                        {{ .Lastmod | time.Format "Monday, Jan 2, 2006" }}
                        {{ end }}</span>
                    {{ end }}
                </p>

                {{ if .Params.tags }}
                <p>
                    {{ $tags := .Params.tags }}
                    {{ if reflect.IsSlice $tags }}
                    {{ range $tags }}
                    <a class="badge badge-outline mr-2" href="{{ " tags" | absURL }}/{{ . | urlize }}"># {{ . }}</a>
                    {{ end }}
                    {{ else }}
                    <a class="badge badge-outline mr-2" href="{{ " tags" | absURL }}/{{ $tags | urlize }}"># {{ $tags
                        }}</a>
                    {{ end }}
                </p>
                {{ end }}
            </header>

            <section id="dream-single-post-content" itemprop="articleBody">
                {{ if and .Params.Cover site.Params.showSummaryCoverInPost }}
                <img class="w-full z-30" src="{{ .Params.Cover }}" alt="{{ .Title }}" />
                {{ end }}

                {{ .Content | emojify }}

            </section>

            {{/* 调试信息 */}}
            <!-- 调试：showPrevNextPost = {{ site.Params.showPrevNextPost }} -->
            <!-- 调试：.Next exists = {{ if .Next }}yes{{ else }}no{{ end }} -->
            <!-- 调试：.Prev exists = {{ if .Prev }}yes{{ else }}no{{ end }} -->

            {{/* 强制显示导航进行测试 */}}
            <div class="divider"></div>
            <div class="flex flex-col md:flex-row justify-between gap-4 py-4">
                {{ with .Next }}
                <a role="button" class="btn btn-outline h-12" href="{{ .RelPermalink }}" title="{{ .Title }}">
                    <ion-icon name="chevron-back"></ion-icon>
                    <div class="inline-flex flex-col items-start">
                        <span class="text-base-content/60 text-xs font-normal">上一篇</span>
                        <span class="max-w-48 truncate">{{ .LinkTitle }}</span>
                    </div>
                </a>
                {{ else }}
                <div><!-- 没有上一篇 --></div>
                {{ end }}

                {{ with .Prev }}
                <a role="button" class="btn btn-outline h-12" href="{{ .RelPermalink }}" title="{{ .Title }}">
                    <div class="inline-flex flex-col items-end">
                        <span class="text-base-content/60 text-xs font-normal">下一篇</span>
                        <span class="max-w-48 truncate">{{ .LinkTitle }}</span>
                    </div>
                    <ion-icon name="chevron-forward"></ion-icon>
                </a>
                {{ else }}
                <div><!-- 没有下一篇 --></div>
                {{ end }}
            </div>

            {{/* Twikoo评论系统 */}}
            {{ if site.Params.twikoo.enabled }}
            <div class="divider mt-8"></div>
            <section class="mt-8">
                <h3 class="text-lg font-semibold mb-4">💬 评论区</h3>
                <div id="tcomment" class="bg-base-100 rounded-lg p-4"></div>
            </section>
            {{ end }}

        </article>
    </div>

    <div x-data="tocHighlighter()" @scroll.window="debouncedScroll"
        class="hidden lg:flex lg:flex-col lg:items-end lg:self-start">
        {{ if site.Params.showTableOfContents }}
        {{ .TableOfContents }}
        {{ end }}
    </div>
</div>
{{ end }}

{{ define "js" }}

{{ if site.Params.Experimental.jsDate }}
{{ partial "luxon.html" . }}
{{ end }}

{{ if site.Params.customSyntaxHighlighting }}
{{- $syntaxLightCSS := resources.Get "css/syntax-light.css" | minify -}}
{{- $syntaxDarkCSS := resources.Get "css/syntax-dark.css" | minify -}}

<script>
    window.customSyntaxHighlighting = {
        light: {{ $syntaxLightCSS.RelPermalink }},
    dark: { { $syntaxDarkCSS.RelPermalink } }
    }

    document.addEventListener('alpine:initialized', () => {
        var isDark = Alpine.store('darkMode').isDark()
        var customSyntaxHighlightingUrl = isDark ? window.customSyntaxHighlighting.dark : window.customSyntaxHighlighting.light

        document
            .querySelector('link[data-custom-syntax-highlighting]')
            .setAttribute('href', customSyntaxHighlightingUrl)
    })
</script>
{{ end }}

{{ $tocJs := resources.Get "js/toc.js" }}
{{ if hugo.IsProduction }}
{{ $tocJs = $tocJs | minify }}
{{ end }}
<script src="{{ $tocJs.RelPermalink }}"></script>

{{ if site.Params.imageZoomableInPost }}
{{ if fileExists "layouts/partials/medium-zoom.html" }}
{{ partialCached "medium-zoom.html" . }}
{{ else }}
<script type="module">
    import mediumZoom from 'https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/+esm';
    mediumZoom('#dream-single-post-content img', {
        background: 'oklch(var(--b1))',
        margin: 24,
    })
</script>
{{ end }}
{{ end }}

{{ if .Params.math }}
{{ .Page.Store.Set "hasMathjax" true }}
{{ end }}

{{/* Twikoo评论系统初始化 */}}
{{ if site.Params.twikoo.enabled }}
<script src="https://cdn.jsdelivr.net/npm/twikoo@1.6.41/dist/twikoo.min.js"></script>
<script>
  twikoo.init({
    envId: '{{ site.Params.twikoo.envID }}',
    el: '#tcomment',
    {{ with site.Params.twikoo.region }}
      region: '{{ . }}',
    {{ end }}
    path: '{{ .RelPermalink }}',
    {{ with site.Params.twikoo.lang }}
      lang: '{{ . }}',
    {{ end }}
  })
</script>
{{ end }}

{{/* 加密模块JavaScript */}}
{{ partial "encrypt/assets/js" . }}

{{ end }}